// SPDX-FileCopyrightText: 2020 VÃ­ctor Aguilera Puerto <zddm@outlook.es>
// SPDX-FileCopyrightText: 2020 ike709 <ike709@users.noreply.github.com>
// SPDX-FileCopyrightText: 2021 Acruid <shatter66@gmail.com>
// SPDX-FileCopyrightText: 2021 Galactic Chimp <63882831+GalacticChimp@users.noreply.github.com>
// SPDX-FileCopyrightText: 2021 Vera Aguilera Puerto <6766154+Zumorica@users.noreply.github.com>
// SPDX-FileCopyrightText: 2022 Flipp Syder <76629141+vulppine@users.noreply.github.com>
// SPDX-FileCopyrightText: 2022 Kara <lunarautomaton6@gmail.com>
// SPDX-FileCopyrightText: 2022 Kevin Zheng <kevinz5000@gmail.com>
// SPDX-FileCopyrightText: 2022 Martin Petkovski <63034378+martin69420@users.noreply.github.com>
// SPDX-FileCopyrightText: 2022 Moony <moonheart08@users.noreply.github.com>
// SPDX-FileCopyrightText: 2022 Morber <14136326+Morb0@users.noreply.github.com>
// SPDX-FileCopyrightText: 2022 Paul Ritter <ritter.paul1@googlemail.com>
// SPDX-FileCopyrightText: 2022 Veritius <veritiusgaming@gmail.com>
// SPDX-FileCopyrightText: 2022 Visne <39844191+Visne@users.noreply.github.com>
// SPDX-FileCopyrightText: 2022 mirrorcult <lunarautomaton6@gmail.com>
// SPDX-FileCopyrightText: 2022 moonheart08 <moonheart08@users.noreply.github.com>
// SPDX-FileCopyrightText: 2022 wrexbe <81056464+wrexbe@users.noreply.github.com>
// SPDX-FileCopyrightText: 2023 ElectroJr <leonsfriedrich@gmail.com>
// SPDX-FileCopyrightText: 2023 PrPleGoo <PrPleGoo@users.noreply.github.com>
// SPDX-FileCopyrightText: 2023 Ygg01 <y.laughing.man.y@gmail.com>
// SPDX-FileCopyrightText: 2024 0x6273 <0x40@keemail.me>
// SPDX-FileCopyrightText: 2024 AJCM-git <60196617+AJCM-git@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Aiden <aiden@djkraz.com>
// SPDX-FileCopyrightText: 2024 Alzore <140123969+Blackern5000@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Brandon Hu <103440971+Brandon-Huu@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 CaasGit <87243814+CaasGit@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Chief-Engineer <119664036+Chief-Engineer@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Cojoke <83733158+Cojoke-dot@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 DrSmugleaf <10968691+DrSmugleaf@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 DrSmugleaf <DrSmugleaf@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Ed <96445749+TheShuEd@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Emisse <99158783+Emisse@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 EmoGarbage404 <retron404@gmail.com>
// SPDX-FileCopyrightText: 2024 Eoin Mcloughlin <helloworld@eoinrul.es>
// SPDX-FileCopyrightText: 2024 Errant <35878406+Errant-4@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Flareguy <78941145+Flareguy@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Hrosts <35345601+Hrosts@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 IProduceWidgets <107586145+IProduceWidgets@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Ian <ignaz.k@live.de>
// SPDX-FileCopyrightText: 2024 Ilya246 <57039557+Ilya246@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Jake Huxell <JakeHuxell@pm.me>
// SPDX-FileCopyrightText: 2024 Joel Zimmerman <JoelZimmerman@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 JustCone <141039037+JustCone14@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Killerqu00 <47712032+Killerqu00@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Ko4ergaPunk <62609550+Ko4ergaPunk@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Kukutis96513 <146854220+Kukutis96513@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Leon Friedrich <60421075+ElectroJr@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Lye <128915833+Lyroth001@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 MerrytheManokit <167581110+MerrytheManokit@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Mervill <mervills.email@gmail.com>
// SPDX-FileCopyrightText: 2024 Mr. 27 <45323883+Dutch-VanDerLinde@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 MureixloI <132683811+MureixloI@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 NakataRin <45946146+NakataRin@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Nemanja <98561806+EmoGarbage404@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 OrangeMoronage9622 <whyteterry0092@gmail.com>
// SPDX-FileCopyrightText: 2024 PJBot <pieterjan.briers+bot@gmail.com>
// SPDX-FileCopyrightText: 2024 Pieter-Jan Briers <pieterjan.briers+git@gmail.com>
// SPDX-FileCopyrightText: 2024 Piras314 <p1r4s@proton.me>
// SPDX-FileCopyrightText: 2024 Plykiya <58439124+Plykiya@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Preston Smith <92108534+thetolbean@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Psychpsyo <60073468+Psychpsyo@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Repo <47093363+Titian3@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 RiceMar1244 <138547931+RiceMar1244@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 ShadowCommander <10494922+ShadowCommander@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Simon <63975668+Simyon264@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 SlamBamActionman <83650252+SlamBamActionman@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Stalen <33173619+stalengd@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 TakoDragon <69509841+BackeTako@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Thomas <87614336+Aeshus@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 TsjipTsjip <19798667+TsjipTsjip@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Ubaser <134914314+UbaserB@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Unkn0wn_Gh0st <shadowstalkermll@gmail.com>
// SPDX-FileCopyrightText: 2024 Vasilis <vasilis@pikachu.systems>
// SPDX-FileCopyrightText: 2024 Vigers Ray <60344369+VigersRay@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 beck-thompson <107373427+beck-thompson@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 deathride58 <deathride58@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 deltanedas <39013340+deltanedas@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 deltanedas <@deltanedas:kde.org>
// SPDX-FileCopyrightText: 2024 dffdff2423 <dffdff2423@gmail.com>
// SPDX-FileCopyrightText: 2024 eoineoineoin <github@eoinrul.es>
// SPDX-FileCopyrightText: 2024 foboscheshir <156405958+foboscheshir@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 github-actions[bot] <41898282+github-actions[bot]@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 lzk <124214523+lzk228@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 metalgearsloth <31366439+metalgearsloth@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 metalgearsloth <comedian_vs_clown@hotmail.com>
// SPDX-FileCopyrightText: 2024 nikthechampiongr <32041239+nikthechampiongr@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 plykiya <plykiya@protonmail.com>
// SPDX-FileCopyrightText: 2024 saintmuntzer <47153094+saintmuntzer@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 shamp <140359015+shampunj@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 slarticodefast <161409025+slarticodefast@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 strO0pwafel <153459934+strO0pwafel@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 stroopwafel <j.o.luijkx@student.tudelft.nl>
// SPDX-FileCopyrightText: 2024 themias <89101928+themias@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 to4no_fix <156101927+chavonadelal@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 voidnull000 <18663194+voidnull000@users.noreply.github.com>
// SPDX-FileCopyrightText: 2025 Aiden <28298836+Aidenkrz@users.noreply.github.com>
// SPDX-FileCopyrightText: 2025 Ignaz "Ian" Kraft <ignaz.k@live.de>
//
// SPDX-License-Identifier: AGPL-3.0-or-later

using System.Linq;
using System.Numerics;
using Content.Client.Administration.UI.CustomControls; // Vortex-LateJoinGui-Update
using Content.Client.CrewManifest;
using Content.Client.GameTicking.Managers;
using Content.Client.Lobby;
using Content.Client.UserInterface.Controls;
using Content.Client.Players.PlayTimeTracking;
using Content.Shared.CCVar;
using Content.Shared.Preferences;
using Content.Shared.Roles;
using Robust.Client.Console;
using Robust.Client.GameObjects;
using Robust.Client.Graphics; // Vortex-LateJoinGui-Update
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Shared.Configuration;
using Robust.Shared.Prototypes;
using Robust.Shared.Utility;
using static Robust.Client.UserInterface.Controls.BoxContainer;

namespace Content.Client.LateJoin
{
    public sealed class LateJoinGui : DefaultWindow
    {
        [Dependency] private readonly IPrototypeManager _prototypeManager = default!;
        [Dependency] private readonly IClientConsoleHost _consoleHost = default!;
        [Dependency] private readonly IConfigurationManager _configManager = default!;
        [Dependency] private readonly IEntitySystemManager _entitySystem = default!;
        [Dependency] private readonly JobRequirementsManager _jobRequirements = default!;
        [Dependency] private readonly IClientPreferencesManager _preferencesManager = default!;
        [Dependency] private readonly ILogManager _logManager = default!;

        public event Action<(NetEntity, string)> SelectedId;

        private readonly ClientGameTicker _gameTicker;
        private readonly SpriteSystem _sprites;
        private readonly CrewManifestSystem _crewManifest;
        private readonly ISawmill _sawmill;

        private readonly Dictionary<NetEntity, Dictionary<string, List<JobButton>>> _jobButtons = new();
        private readonly Dictionary<NetEntity, Dictionary<string, BoxContainer>> _jobCategories = new();

        // Vortex-LateJoinGui-Update start
        private NetEntity? _selectedStation;
        private Button? _selectedStationButton;
        private ScrollContainer _stationListScroll = default!;
        private ScrollContainer _jobListScroll = default!;
        private BoxContainer _stationList = default!;
        private BoxContainer _jobList = default!;
        // Vortex-LateJoinGui-Update end

        private readonly Control _base;

        public LateJoinGui()
        {
            MinSize = SetSize = new Vector2(820, 560); // Vortex-LateJoinGui-Update edited
            IoCManager.InjectDependencies(this);
            _sprites = _entitySystem.GetEntitySystem<SpriteSystem>();
            _crewManifest = _entitySystem.GetEntitySystem<CrewManifestSystem>();
            _gameTicker = _entitySystem.GetEntitySystem<ClientGameTicker>();
            _sawmill = _logManager.GetSawmill("latejoin.panel");

            Title = Loc.GetString("late-join-gui-title");

            _base = new BoxContainer()
            {   // Vortex-LateJoinGui-Update start
                Orientation = LayoutOrientation.Horizontal,
                HorizontalExpand = true,
                // Vortex-LateJoinGui-Update end
            };

            Contents.AddChild(_base);

            _jobRequirements.Updated += RebuildUI;
            RebuildUI();

            SelectedId += x =>
            {
                var (station, jobId) = x;
                _sawmill.Info($"Late joining as ID: {jobId}");
                _consoleHost.ExecuteCommand($"joingame {CommandParsing.Escape(jobId)} {station}");
                Close();
            };

            _gameTicker.LobbyJobsAvailableUpdated += JobsAvailableUpdated;
        }

        private void RebuildUI()
        {
            _base.RemoveAllChildren();
            _jobButtons.Clear();
            _jobCategories.Clear();
            _selectedStation = null; // Vortex-LateJoinGui-Update

            // Vortex-LateJoinGui-Update start
            if (!_gameTicker.DisallowedLateJoin && _gameTicker.StationNames.Count == 0)
            {
                _sawmill.Warning("No stations exist, nothing to display in late-join GUI");
                _base.AddChild(new Label { Text = Loc.GetString("late-join-gui-no-stations") });
                return;
            }

            // Left panel: station list
            _stationList = new BoxContainer { Orientation = LayoutOrientation.Vertical };
            _stationListScroll = new ScrollContainer { Children = { _stationList }, VerticalExpand = true, MinWidth = 310, MaxWidth = 310, HorizontalExpand = false };

            // Right panel: job list
            _jobList = new BoxContainer { Orientation = LayoutOrientation.Vertical };
            _jobListScroll = new ScrollContainer { Children = { _jobList }, VerticalExpand = true, MinWidth = 420, MaxWidth = 800, HorizontalExpand = true };

            _base.AddChild(_stationListScroll);
            var separator = new VSeparator();
            separator.MinSize = new Vector2(4, 0);
            separator.HorizontalExpand = false;
            separator.VerticalExpand = true;
            separator.Margin = new Thickness(3, 0, 3, 0);
            _base.AddChild(separator); // Separator
            _base.AddChild(_jobListScroll);

            // Build station buttons
            foreach (var (id, name) in _gameTicker.StationNames)
            {
                var stationButton = new Button { Text = name };
                stationButton.OnPressed += _ => SelectStation(stationButton, id);
                _stationList.AddChild(stationButton);

                // Pre-build job data
                BuildJobDataForStation(id);
            }

            // Auto-select first station
            if (_gameTicker.StationNames.Count > 0)
            {
                var firstStation = _gameTicker.StationNames.Keys.First();
                _selectedStation = firstStation;
                // Find the first button and highlight it
                if (_stationList.Children.FirstOrDefault() is Button firstButton)
                {
                    _selectedStationButton = firstButton;
                    _selectedStationButton.ModulateSelfOverride = Color.FromHex("#274c8d"); // Selected color
                }
                UpdateJobList();
            }
        }

        private void BuildJobDataForStation(NetEntity stationId)
        {
            _jobButtons[stationId] = new Dictionary<string, List<JobButton>>();
            _jobCategories[stationId] = new Dictionary<string, BoxContainer>();

            var departments = _prototypeManager.EnumeratePrototypes<DepartmentPrototype>().ToArray();
            Array.Sort(departments, DepartmentUIComparer.Instance);

            foreach (var department in departments)
            {
                var departmentName = Loc.GetString(department.Name);
                var stationAvailable = _gameTicker.JobsAvailable[stationId];
                var jobsAvailable = new List<JobPrototype>();

                foreach (var jobId in department.Roles)
                {
                    if (!stationAvailable.ContainsKey(jobId))
                        continue;

                    jobsAvailable.Add(_prototypeManager.Index<JobPrototype>(jobId));
                }

                jobsAvailable.Sort(JobUIComparer.Instance);

                // Do not create categories with no jobs available.
                if (jobsAvailable.Count == 0)
                    continue;

                var category = new BoxContainer
                {
                    Orientation = LayoutOrientation.Vertical,
                    Name = department.ID,
                    ToolTip = Loc.GetString("late-join-gui-jobs-amount-in-department-tooltip",
                        ("departmentName", departmentName))
                };

                category.AddChild(new PanelContainer
                {
                    Children =
                    {
                        new Label
                        {
                            StyleClasses = { "LabelBig" },
                            Text = Loc.GetString("late-join-gui-department-jobs-label", ("departmentName", departmentName))
                        }
                    }
                });

                _jobCategories[stationId][department.ID] = category;

                foreach (var prototype in jobsAvailable)
                {
                    var value = stationAvailable[prototype.ID];

                    var jobLabel = new Label
                    {
                        Margin = new Thickness(5f, 0, 0, 0)
                    };

                    var jobButton = new JobButton(jobLabel, prototype.ID, prototype.LocalizedName, value);

                    var jobSelector = new BoxContainer
                    {
                        Orientation = LayoutOrientation.Horizontal,
                        HorizontalExpand = true
                    };

                    var icon = new TextureRect
                    {
                        TextureScale = new Vector2(2, 2),
                        VerticalAlignment = VAlignment.Center
                    };

                    var jobIcon = _prototypeManager.Index(prototype.Icon);
                    icon.Texture = _sprites.Frame0(jobIcon.Icon);
                    jobSelector.AddChild(icon);

                    jobSelector.AddChild(jobLabel);
                    jobButton.AddChild(jobSelector);

                    jobButton.OnPressed += _ => SelectedId.Invoke((stationId, jobButton.JobId));

                    if (!_jobRequirements.IsAllowed(prototype, (HumanoidCharacterProfile?)_preferencesManager.Preferences?.SelectedCharacter, out var reason))
                    {
                        jobButton.Disabled = true;

                        if (!reason.IsEmpty)
                        {
                            var tooltip = new Tooltip();
                            tooltip.SetMessage(reason);
                            jobButton.TooltipSupplier = _ => tooltip;
                        }

                        jobSelector.AddChild(new TextureRect
                        {
                            TextureScale = new Vector2(0.4f, 0.4f),
                            Stretch = TextureRect.StretchMode.KeepCentered,
                            Texture = _sprites.Frame0(new SpriteSpecifier.Texture(new ("/Textures/Interface/Nano/lock.svg.192dpi.png"))),
                            HorizontalExpand = true,
                            HorizontalAlignment = HAlignment.Right,
                        });
                    }
                    else if (value == 0)
                    {
                        jobButton.Disabled = true;
                    }

                    if (!_jobButtons[stationId].ContainsKey(prototype.ID))
                    {
                        _jobButtons[stationId][prototype.ID] = new List<JobButton>();
                    }

                    _jobButtons[stationId][prototype.ID].Add(jobButton);
                    category.AddChild(jobButton);
                }
            }
        }

        private void SelectStation(Button button, NetEntity stationId)
        {
            // Reset previous button color
            if (_selectedStationButton != null)
            {
                _selectedStationButton.ModulateSelfOverride = null;
            }

            _selectedStationButton = button;
            _selectedStationButton.ModulateSelfOverride = Color.FromHex("#274c8d"); // Selected color

            _selectedStation = stationId;
            UpdateJobList();
        }

        private void UpdateJobList()
        {
            _jobList.RemoveAllChildren();

            if (_selectedStation == null || !_jobCategories.ContainsKey(_selectedStation.Value))
                return;

            var stationId = _selectedStation.Value;

            // Add crew manifest button if enabled
            if (_configManager.GetCVar(CCVars.CrewManifestWithoutEntity))
            {
                var crewManifestButton = new Button()
                {
                    Text = Loc.GetString("crew-manifest-button-label"),
                    HorizontalExpand = true
                };
                crewManifestButton.OnPressed += _ => _crewManifest.RequestCrewManifest(stationId);
                _jobList.AddChild(crewManifestButton);
            }

            var firstCategory = true;
            foreach (var category in _jobCategories[stationId].Values)
            {
                if (!firstCategory)
                {
                    _jobList.AddChild(new Control { MinSize = new Vector2(0, 23) });
                }
                firstCategory = false;
                _jobList.AddChild(category);
            }
        }
        // Vortex-LateJoinGui-Update end

        private void JobsAvailableUpdated(IReadOnlyDictionary<NetEntity, Dictionary<ProtoId<JobPrototype>, int?>> updatedJobs)
        {
            foreach (var stationEntries in updatedJobs)
            {
                if (_jobButtons.ContainsKey(stationEntries.Key))
                {
                    var jobsAvailable = stationEntries.Value;

                    var existingJobEntries = _jobButtons[stationEntries.Key];
                    foreach (var existingJobEntry in existingJobEntries)
                    {
                        if (jobsAvailable.ContainsKey(existingJobEntry.Key))
                        {
                            var updatedJobValue = jobsAvailable[existingJobEntry.Key];
                            foreach (var matchingJobButton in existingJobEntry.Value)
                            {
                                if (matchingJobButton.Amount != updatedJobValue)
                                {
                                    matchingJobButton.RefreshLabel(updatedJobValue);
                                    matchingJobButton.Disabled |= matchingJobButton.Amount == 0;
                                }
                            }
                        }
                    }
                }
                // Vortex-LateJoinGui-Update start

                // If the selected station was updated, refresh the job list
                if (_selectedStation == stationEntries.Key)
                {
                    UpdateJobList();
                }
                // Vortex-LateJoinGui-Update end
            }
        }

        protected override void Dispose(bool disposing)
        {
            base.Dispose(disposing);

            if (disposing)
            {
                _jobRequirements.Updated -= RebuildUI;
                _gameTicker.LobbyJobsAvailableUpdated -= JobsAvailableUpdated;
                _jobButtons.Clear();
                _jobCategories.Clear();
            }
        }
    }

    sealed class JobButton : ContainerButton
    {
        public Label JobLabel { get; }
        public string JobId { get; }
        public string JobLocalisedName { get; }
        public int? Amount { get; private set; }
        private bool _initialised = false;

        public JobButton(Label jobLabel, ProtoId<JobPrototype> jobId, string jobLocalisedName, int? amount)
        {
            JobLabel = jobLabel;
            JobId = jobId;
            JobLocalisedName = jobLocalisedName;
            RefreshLabel(amount);
            AddStyleClass(StyleClassButton);
            _initialised = true;
        }

        public void RefreshLabel(int? amount)
        {
            if (Amount == amount && _initialised)
            {
                return;
            }
            Amount = amount;

            JobLabel.Text = Amount != null ?
                Loc.GetString("late-join-gui-job-slot-capped", ("jobName", JobLocalisedName), ("amount", Amount)) :
                Loc.GetString("late-join-gui-job-slot-uncapped", ("jobName", JobLocalisedName));
        }
    }
}